/**
 * @fileoverview added by tsickle
 * Generated from: lib/iamport-ionic4-kcp.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { IamportPayment } from "./iamport.payment";
import { IamportCertification } from "./iamport.certification";
import { Platform } from "@ionic/angular";
import { File } from "@ionic-native/file/ngx";
import { InAppBrowser } from "@ionic-native/in-app-browser/ngx";
import * as i0 from "@angular/core";
import * as i1 from "@ionic/angular";
import * as i2 from "@ionic-native/in-app-browser/ngx/index";
import * as i3 from "@ionic-native/file/ngx/index";
export class IamportService {
    /**
     * @param {?} platform
     * @param {?} inAppBrowser
     * @param {?} file
     */
    constructor(platform, inAppBrowser, file) {
        this.platform = platform;
        this.inAppBrowser = inAppBrowser;
        this.file = file;
    }
    /**
     * @private
     * @param {?} query
     * @return {?}
     */
    static parseQuery(query) {
        /** @type {?} */
        let obj = {};
        /** @type {?} */
        let arr = query.split('&');
        for (let element of arr) {
            /** @type {?} */
            const pair = element.split("=");
            /** @type {?} */
            const key = decodeURIComponent(pair[0]);
            /** @type {?} */
            const val = decodeURIComponent(pair[1]);
            if (key === "imp_success") {
                obj["success"] = ("true" === val); //string 을 boolean 으로
            }
            else {
                obj[key] = val;
            }
        }
        return obj;
    }
    /**
     * @param {?} userCode
     * @param {?} param
     * @return {?}
     */
    payment(userCode, param) {
        /** @type {?} */
        const promise = new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            this.platform.ready().then((/**
             * @return {?}
             */
            () => {
                /** @type {?} */
                let paymentUrl = '/_iamport_file_/www/iamport-checkout.html?user-code=' + userCode;
                if (this.platform.is('ios')) {
                    paymentUrl = this.file.applicationDirectory + 'www/iamport-checkout-ios.html?user-code=' + userCode;
                }
                /** @type {?} */
                const redirectUrl = "http://localhost/iamport";
                /** @type {?} */
                const browser = this.inAppBrowser.create(paymentUrl, '_blank', 'location=no');
                /** @type {?} */
                let paymentProgress = false;
                param.m_redirect_url = redirectUrl;
                browser.on("loadstart")
                    .subscribe((/**
                 * @param {?} e
                 * @return {?}
                 */
                (e) => {
                    if (e.url.startsWith(redirectUrl)) {
                        /** @type {?} */
                        const query = e.url.substring(redirectUrl.length + 1);
                        /** @type {?} */
                        const data = IamportService.parseQuery(query);
                        resolve(new IamportPayment(data));
                        browser.close();
                    }
                }));
                browser.on("loadstop")
                    .subscribe((/**
                 * @param {?} e
                 * @return {?}
                 */
                (e) => {
                    if (!paymentProgress && (e.url).indexOf(paymentUrl) > -1) {
                        paymentProgress = true;
                        /** @type {?} */
                        const inlineCallback = `(rsp) => {
                                                        if( rsp.success ) {
                                                            location.href = '${redirectUrl}?imp_success=true&imp_uid='+rsp.imp_uid+'&merchant_uid='+rsp.merchant_uid+'&vbank_num='+rsp.vbank_num+'&vbank_name='+rsp.vbank_name;
                                                        } else {
                                                            location.href = '${redirectUrl}?imp_success=false&imp_uid='+rsp.imp_uid+'&merchant_uid='+rsp.merchant_uid+'&error_msg='+rsp.error_msg;
                                                        }
                                                   }`;
                        /** @type {?} */
                        const iamport_script = `IMP.request_pay(${JSON.stringify(param)}, ${inlineCallback})`;
                        browser.executeScript({
                            code: iamport_script
                        });
                    }
                }), (/**
                 * @param {?} e
                 * @return {?}
                 */
                (e) => {
                }));
                browser.on("exit")
                    .subscribe((/**
                 * @param {?} e
                 * @return {?}
                 */
                (e) => {
                    reject("사용자가 결제를 취소하였습니다.");
                }));
                browser.show();
            }));
        }));
        return promise;
    }
    /**
     * @param {?} userCode
     * @param {?} param
     * @return {?}
     */
    certification(userCode, param) {
        /** @type {?} */
        const promise = new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            this.platform.ready().then((/**
             * @return {?}
             */
            () => {
                /** @type {?} */
                let certificationUrl = '/_iamport_file_/www/iamport-checkout.html?user-code=' + userCode;
                if (this.platform.is('ios')) {
                    certificationUrl = this.file.applicationDirectory + 'www/iamport-checkout-ios.html?user-code=' + userCode;
                }
                /** @type {?} */
                const redirectUrl = "http://localhost/iamport-certification";
                /** @type {?} */
                const browser = this.inAppBrowser.create(certificationUrl, '_blank', 'location=no');
                /** @type {?} */
                let certificationProgress = false;
                browser.on("loadstart")
                    .subscribe((/**
                 * @param {?} e
                 * @return {?}
                 */
                (e) => {
                    if (e.url.startsWith(redirectUrl)) {
                        /** @type {?} */
                        const query = e.url.substring(redirectUrl.length + 1);
                        /** @type {?} */
                        const data = IamportService.parseQuery(query);
                        resolve(new IamportCertification(data));
                        browser.close();
                    }
                }));
                browser.on("loadstop")
                    .subscribe((/**
                 * @param {?} e
                 * @return {?}
                 */
                (e) => {
                    if (!certificationProgress && (e.url).indexOf(certificationUrl) > -1) {
                        certificationProgress = true;
                        /** @type {?} */
                        const inlineCallback = `(rsp) => {
                                                        if( rsp.success ) {
                                                            location.href = '${redirectUrl}?imp_success=true&imp_uid='+rsp.imp_uid+'&merchant_uid='+rsp.merchant_uid;
                                                        } else {
                                                            location.href = '${redirectUrl}?imp_success=false&imp_uid='+rsp.imp_uid+'&merchant_uid='+rsp.merchant_uid;
                                                        }
                                                   }`;
                        /** @type {?} */
                        const iamport_script = `IMP.certification(${JSON.stringify(param)}, ${inlineCallback})`;
                        browser.executeScript({
                            code: iamport_script
                        });
                    }
                }), (/**
                 * @param {?} e
                 * @return {?}
                 */
                (e) => {
                }));
                browser.on("exit")
                    .subscribe((/**
                 * @param {?} e
                 * @return {?}
                 */
                (e) => {
                    reject("사용자가 본인인증을 취소하였습니다.");
                }));
                browser.show();
            }));
        }));
        return promise;
    }
}
IamportService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
IamportService.ctorParameters = () => [
    { type: Platform },
    { type: InAppBrowser },
    { type: File }
];
/** @nocollapse */ IamportService.ngInjectableDef = i0.defineInjectable({ factory: function IamportService_Factory() { return new IamportService(i0.inject(i1.Platform), i0.inject(i2.InAppBrowser), i0.inject(i3.File)); }, token: IamportService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    IamportService.prototype.platform;
    /**
     * @type {?}
     * @private
     */
    IamportService.prototype.inAppBrowser;
    /**
     * @type {?}
     * @private
     */
    IamportService.prototype.file;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWFtcG9ydC1pb25pYzQta2NwLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9pYW1wb3J0LWlvbmljNC1rY3AvIiwic291cmNlcyI6WyJsaWIvaWFtcG9ydC1pb25pYzQta2NwLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sRUFBQyxjQUFjLEVBQUMsTUFBTSxtQkFBbUIsQ0FBQztBQUNqRCxPQUFPLEVBQUMsb0JBQW9CLEVBQUMsTUFBTSx5QkFBeUIsQ0FBQztBQUM3RCxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEMsT0FBTyxFQUFDLElBQUksRUFBQyxNQUFNLHdCQUF3QixDQUFDO0FBQzVDLE9BQU8sRUFBQyxZQUFZLEVBQUMsTUFBTSxrQ0FBa0MsQ0FBQzs7Ozs7QUFLOUQsTUFBTSxPQUFPLGNBQWM7Ozs7OztJQUV6QixZQUFvQixRQUFrQixFQUFVLFlBQTBCLEVBQVUsSUFBVTtRQUExRSxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQVUsaUJBQVksR0FBWixZQUFZLENBQWM7UUFBVSxTQUFJLEdBQUosSUFBSSxDQUFNO0lBRTlGLENBQUM7Ozs7OztJQUVPLE1BQU0sQ0FBQyxVQUFVLENBQUMsS0FBYTs7WUFDakMsR0FBRyxHQUFHLEVBQUU7O1lBQ1IsR0FBRyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDO1FBRTFCLEtBQUssSUFBSSxPQUFPLElBQUksR0FBRyxFQUFFOztrQkFDakIsSUFBSSxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDOztrQkFDekIsR0FBRyxHQUFHLGtCQUFrQixDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQzs7a0JBQ2pDLEdBQUcsR0FBRyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFdkMsSUFBSSxHQUFHLEtBQUss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QUFDLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUU7d0JBQ3BFLHFCQUFxQixHQUFHLElBQUksQ0FBQzs7OEJBRXZCLGNBQWMsR0FBRzs7K0VBRW9DLFdBQVc7OytFQUVYLFdBQVc7O3FEQUVyQzs7OEJBQzNCLGNBQWMsR0FBRyxxQkFBcUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsS0FBSyxjQUFjLEdBQUc7d0JBRXZGLE9BQU8sQ0FBQyxhQUFhLENBQUM7NEJBQ3BCLElBQUksRUFBRSxjQUFjO3lCQUNyQixDQUFDLENBQUM7cUJBQ0o7Z0JBQ0gsQ0FBQzs7OztnQkFBRSxDQUFDLENBQUMsRUFBRSxFQUFFO2dCQUVULENBQUMsRUFDSixDQUFDO2dCQUVOLE9BQU8sQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDO3FCQUNiLFNBQVM7Ozs7Z0JBQ04sQ0FBQyxDQUFDLEVBQUUsRUFBRTtvQkFDSixNQUFNLENBQUMscUJBQXFCLENBQUMsQ0FBQztnQkFDaEMsQ0FBQyxFQUNKLENBQUM7Z0JBRU4sT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ2pCLENBQUMsRUFBQyxDQUFDO1FBQ0wsQ0FBQyxFQUFDO1FBRUYsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQzs7O1lBM0pGLFVBQVUsU0FBQztnQkFDVixVQUFVLEVBQUUsTUFBTTthQUNuQjs7OztZQU5PLFFBQVE7WUFFUixZQUFZO1lBRFosSUFBSTs7Ozs7Ozs7SUFRRSxrQ0FBMEI7Ozs7O0lBQUUsc0NBQWtDOzs7OztJQUFFLDhCQUFrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SW5qZWN0YWJsZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge0lhbXBvcnRQYXltZW50fSBmcm9tIFwiLi9pYW1wb3J0LnBheW1lbnRcIjtcbmltcG9ydCB7SWFtcG9ydENlcnRpZmljYXRpb259IGZyb20gXCIuL2lhbXBvcnQuY2VydGlmaWNhdGlvblwiO1xuaW1wb3J0IHtQbGF0Zm9ybX0gZnJvbSBcIkBpb25pYy9hbmd1bGFyXCI7XG5pbXBvcnQge0ZpbGV9IGZyb20gXCJAaW9uaWMtbmF0aXZlL2ZpbGUvbmd4XCI7XG5pbXBvcnQge0luQXBwQnJvd3Nlcn0gZnJvbSBcIkBpb25pYy1uYXRpdmUvaW4tYXBwLWJyb3dzZXIvbmd4XCI7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIElhbXBvcnRTZXJ2aWNlIHtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHBsYXRmb3JtOiBQbGF0Zm9ybSwgcHJpdmF0ZSBpbkFwcEJyb3dzZXI6IEluQXBwQnJvd3NlciwgcHJpdmF0ZSBmaWxlOiBGaWxlKSB7XG5cbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIHBhcnNlUXVlcnkocXVlcnk6IHN0cmluZykge1xuICAgIGxldCBvYmogPSB7fSxcbiAgICAgICAgYXJyID0gcXVlcnkuc3BsaXQoJyYnKTtcblxuICAgIGZvciAobGV0IGVsZW1lbnQgb2YgYXJyKSB7XG4gICAgICBjb25zdCBwYWlyID0gZWxlbWVudC5zcGxpdChcIj1cIik7XG4gICAgICBjb25zdCBrZXkgPSBkZWNvZGVVUklDb21wb25lbnQocGFpclswXSk7XG4gICAgICBjb25zdCB2YWwgPSBkZWNvZGVVUklDb21wb25lbnQocGFpclsxXSk7XG5cbiAgICAgIGlmIChrZXkgPT09IFwiaW1wX3N1Y2Nlc3NcIikge1xuICAgICAgICBvYmpbXCJzdWNjZXNzXCJdID0gKFwidHJ1ZVwiID09PSB2YWwpOyAvL3N0cmluZyDsnYQgYm9vbGVhbiDsnLzroZxcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG9ialtrZXldID0gdmFsO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBvYmo7XG4gIH1cblxuICBwdWJsaWMgcGF5bWVudCh1c2VyQ29kZTogc3RyaW5nLCBwYXJhbSk6IFByb21pc2U8SWFtcG9ydFBheW1lbnQ+IHtcbiAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2U8SWFtcG9ydFBheW1lbnQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMucGxhdGZvcm0ucmVhZHkoKS50aGVuKCgpID0+IHtcbiAgICAgICAgbGV0IHBheW1lbnRVcmwgPSAnL19pYW1wb3J0X2ZpbGVfL3d3dy9pYW1wb3J0LWNoZWNrb3V0Lmh0bWw/dXNlci1jb2RlPScgKyB1c2VyQ29kZTtcbiAgICAgICAgaWYgKHRoaXMucGxhdGZvcm0uaXMoJ2lvcycpKSB7XG4gICAgICAgICAgcGF5bWVudFVybCA9IHRoaXMuZmlsZS5hcHBsaWNhdGlvbkRpcmVjdG9yeSArICd3d3cvaWFtcG9ydC1jaGVja291dC1pb3MuaHRtbD91c2VyLWNvZGU9JyArIHVzZXJDb2RlO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVkaXJlY3RVcmwgPSBcImh0dHA6Ly9sb2NhbGhvc3QvaWFtcG9ydFwiO1xuICAgICAgICBjb25zdCBicm93c2VyID0gdGhpcy5pbkFwcEJyb3dzZXIuY3JlYXRlKHBheW1lbnRVcmwsICdfYmxhbmsnLCAnbG9jYXRpb249bm8nKTtcbiAgICAgICAgbGV0IHBheW1lbnRQcm9ncmVzcyA9IGZhbHNlO1xuXG4gICAgICAgIHBhcmFtLm1fcmVkaXJlY3RfdXJsID0gcmVkaXJlY3RVcmw7XG5cbiAgICAgICAgYnJvd3Nlci5vbihcImxvYWRzdGFydFwiKVxuICAgICAgICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAoZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgaWYgKGUudXJsLnN0YXJ0c1dpdGgocmVkaXJlY3RVcmwpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHF1ZXJ5ID0gZS51cmwuc3Vic3RyaW5nKHJlZGlyZWN0VXJsLmxlbmd0aCArIDEpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gSWFtcG9ydFNlcnZpY2UucGFyc2VRdWVyeShxdWVyeSk7XG5cbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShuZXcgSWFtcG9ydFBheW1lbnQoZGF0YSkpO1xuICAgICAgICAgICAgICAgICAgICBicm93c2VyLmNsb3NlKCk7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcblxuICAgICAgICBicm93c2VyLm9uKFwibG9hZHN0b3BcIilcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgKGUpID0+IHtcbiAgICAgICAgICAgICAgICAgIGlmICghcGF5bWVudFByb2dyZXNzICYmIChlLnVybCkuaW5kZXhPZihwYXltZW50VXJsKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIHBheW1lbnRQcm9ncmVzcyA9IHRydWU7XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5saW5lQ2FsbGJhY2sgPSBgKHJzcCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiggcnNwLnN1Y2Nlc3MgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhdGlvbi5ocmVmID0gJyR7cmVkaXJlY3RVcmx9P2ltcF9zdWNjZXNzPXRydWUmaW1wX3VpZD0nK3JzcC5pbXBfdWlkKycmbWVyY2hhbnRfdWlkPScrcnNwLm1lcmNoYW50X3VpZCsnJnZiYW5rX251bT0nK3JzcC52YmFua19udW0rJyZ2YmFua19uYW1lPScrcnNwLnZiYW5rX25hbWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhdGlvbi5ocmVmID0gJyR7cmVkaXJlY3RVcmx9P2ltcF9zdWNjZXNzPWZhbHNlJmltcF91aWQ9Jytyc3AuaW1wX3VpZCsnJm1lcmNoYW50X3VpZD0nK3JzcC5tZXJjaGFudF91aWQrJyZlcnJvcl9tc2c9Jytyc3AuZXJyb3JfbXNnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9YDtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaWFtcG9ydF9zY3JpcHQgPSBgSU1QLnJlcXVlc3RfcGF5KCR7SlNPTi5zdHJpbmdpZnkocGFyYW0pfSwgJHtpbmxpbmVDYWxsYmFja30pYDtcblxuICAgICAgICAgICAgICAgICAgICBicm93c2VyLmV4ZWN1dGVTY3JpcHQoe1xuICAgICAgICAgICAgICAgICAgICAgIGNvZGU6IGlhbXBvcnRfc2NyaXB0XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sIChlKSA9PiB7XG5cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuXG4gICAgICAgIGJyb3dzZXIub24oXCJleGl0XCIpXG4gICAgICAgICAgICAuc3Vic2NyaWJlKFxuICAgICAgICAgICAgICAgIChlKSA9PiB7XG4gICAgICAgICAgICAgICAgICByZWplY3QoXCLsgqzsmqnsnpDqsIAg6rKw7KCc66W8IOy3qOyGjO2VmOyYgOyKteuLiOuLpC5cIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcblxuICAgICAgICBicm93c2VyLnNob3coKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHByb21pc2U7XG4gIH1cblxuICBwdWJsaWMgY2VydGlmaWNhdGlvbih1c2VyQ29kZTogc3RyaW5nLCBwYXJhbSk6IFByb21pc2U8SWFtcG9ydENlcnRpZmljYXRpb24+IHtcbiAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2U8SWFtcG9ydENlcnRpZmljYXRpb24+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMucGxhdGZvcm0ucmVhZHkoKS50aGVuKCgpID0+IHtcbiAgICAgICAgbGV0IGNlcnRpZmljYXRpb25VcmwgPSAnL19pYW1wb3J0X2ZpbGVfL3d3dy9pYW1wb3J0LWNoZWNrb3V0Lmh0bWw/dXNlci1jb2RlPScgKyB1c2VyQ29kZTtcbiAgICAgICAgaWYgKHRoaXMucGxhdGZvcm0uaXMoJ2lvcycpKSB7XG4gICAgICAgICAgY2VydGlmaWNhdGlvblVybCA9IHRoaXMuZmlsZS5hcHBsaWNhdGlvbkRpcmVjdG9yeSArICd3d3cvaWFtcG9ydC1jaGVja291dC1pb3MuaHRtbD91c2VyLWNvZGU9JyArIHVzZXJDb2RlO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVkaXJlY3RVcmwgPSBcImh0dHA6Ly9sb2NhbGhvc3QvaWFtcG9ydC1jZXJ0aWZpY2F0aW9uXCI7XG4gICAgICAgIGNvbnN0IGJyb3dzZXIgPSB0aGlzLmluQXBwQnJvd3Nlci5jcmVhdGUoY2VydGlmaWNhdGlvblVybCwgJ19ibGFuaycsICdsb2NhdGlvbj1ubycpO1xuXG4gICAgICAgIGxldCBjZXJ0aWZpY2F0aW9uUHJvZ3Jlc3MgPSBmYWxzZTtcblxuICAgICAgICBicm93c2VyLm9uKFwibG9hZHN0YXJ0XCIpXG4gICAgICAgICAgICAuc3Vic2NyaWJlKFxuICAgICAgICAgICAgICAgIChlKSA9PiB7XG4gICAgICAgICAgICAgICAgICBpZiAoZS51cmwuc3RhcnRzV2l0aChyZWRpcmVjdFVybCkpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcXVlcnkgPSBlLnVybC5zdWJzdHJpbmcocmVkaXJlY3RVcmwubGVuZ3RoICsgMSk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBJYW1wb3J0U2VydmljZS5wYXJzZVF1ZXJ5KHF1ZXJ5KTtcblxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKG5ldyBJYW1wb3J0Q2VydGlmaWNhdGlvbihkYXRhKSk7XG4gICAgICAgICAgICAgICAgICAgIGJyb3dzZXIuY2xvc2UoKTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuXG4gICAgICAgIGJyb3dzZXIub24oXCJsb2Fkc3RvcFwiKVxuICAgICAgICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAoZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgaWYgKCFjZXJ0aWZpY2F0aW9uUHJvZ3Jlc3MgJiYgKGUudXJsKS5pbmRleE9mKGNlcnRpZmljYXRpb25VcmwpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgY2VydGlmaWNhdGlvblByb2dyZXNzID0gdHJ1ZTtcblxuICAgICAgICAgICAgICAgICAgICBjb25zdCBpbmxpbmVDYWxsYmFjayA9IGAocnNwKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCByc3Auc3VjY2VzcyApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uLmhyZWYgPSAnJHtyZWRpcmVjdFVybH0/aW1wX3N1Y2Nlc3M9dHJ1ZSZpbXBfdWlkPScrcnNwLmltcF91aWQrJyZtZXJjaGFudF91aWQ9Jytyc3AubWVyY2hhbnRfdWlkO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYXRpb24uaHJlZiA9ICcke3JlZGlyZWN0VXJsfT9pbXBfc3VjY2Vzcz1mYWxzZSZpbXBfdWlkPScrcnNwLmltcF91aWQrJyZtZXJjaGFudF91aWQ9Jytyc3AubWVyY2hhbnRfdWlkO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9YDtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaWFtcG9ydF9zY3JpcHQgPSBgSU1QLmNlcnRpZmljYXRpb24oJHtKU09OLnN0cmluZ2lmeShwYXJhbSl9LCAke2lubGluZUNhbGxiYWNrfSlgO1xuXG4gICAgICAgICAgICAgICAgICAgIGJyb3dzZXIuZXhlY3V0ZVNjcmlwdCh7XG4gICAgICAgICAgICAgICAgICAgICAgY29kZTogaWFtcG9ydF9zY3JpcHRcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSwgKGUpID0+IHtcblxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgYnJvd3Nlci5vbihcImV4aXRcIilcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgKGUpID0+IHtcbiAgICAgICAgICAgICAgICAgIHJlamVjdChcIuyCrOyaqeyekOqwgCDrs7jsnbjsnbjspp3snYQg7Leo7IaM7ZWY7JiA7Iq164uI64ukLlwiKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuXG4gICAgICAgIGJyb3dzZXIuc2hvdygpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gcHJvbWlzZTtcbiAgfVxufVxuIl19