/**
 * @fileoverview added by tsickle
 * Generated from: lib/iamport-ionic4-kcp.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { IamportPayment } from "./iamport.payment";
import { IamportCertification } from "./iamport.certification";
import { Platform } from "@ionic/angular";
import { File } from "@ionic-native/file/ngx";
import { InAppBrowser } from "@ionic-native/in-app-browser/ngx";
import * as i0 from "@angular/core";
import * as i1 from "@ionic/angular";
import * as i2 from "@ionic-native/in-app-browser/ngx/index";
import * as i3 from "@ionic-native/file/ngx/index";
var IamportService = /** @class */ (function () {
    function IamportService(platform, inAppBrowser, file) {
        this.platform = platform;
        this.inAppBrowser = inAppBrowser;
        this.file = file;
    }
    /**
     * @private
     * @param {?} query
     * @return {?}
     */
    IamportService.parseQuery = /**
     * @private
     * @param {?} query
     * @return {?}
     */
    function (query) {
        var e_1, _a;
        /** @type {?} */
        var obj = {};
        /** @type {?} */
        var arr = query.split('&');
        try {
            for (var arr_1 = tslib_1.__values(arr), arr_1_1 = arr_1.next(); !arr_1_1.done; arr_1_1 = arr_1.next()) {
                var element = arr_1_1.value;
                /** @type {?} */
                var pair = element.split("=");
                /** @type {?} */
                var key = decodeURIComponent(pair[0]);
                /** @type {?} */
                var val = decodeURIComponent(pair[1]);
                if (key === "imp_success") {
                    obj["success"] = ("true" === val); //string 을 boolean 으로
                }
                else {
                    obj[key] = val;
                }
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (arr_1_1 && !arr_1_1.done && (_a = arr_1.return)) _a.call(arr_1);
            }
            finally { if (e_1) throw e_1.error; }
        }
        return obj;
    };
    /**
     * @param {?} userCode
     * @param {?} param
     * @return {?}
     */
    IamportService.prototype.payment = /**
     * @param {?} userCode
     * @param {?} param
     * @return {?}
     */
    function (userCode, param) {
        var _this = this;
        /** @type {?} */
        var promise = new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        function (resolve, reject) {
            _this.platform.ready().then((/**
             * @return {?}
             */
            function () {
                /** @type {?} */
                var paymentUrl = '/_iamport_file_/www/iamport-checkout.html?user-code=' + userCode;
                if (_this.platform.is('ios')) {
                    paymentUrl = _this.file.applicationDirectory + 'www/iamport-checkout-ios.html?user-code=' + userCode;
                }
                /** @type {?} */
                var redirectUrl = "http://localhost/iamport";
                /** @type {?} */
                var browser = _this.inAppBrowser.create(paymentUrl, '_blank', 'location=no');
                /** @type {?} */
                var paymentProgress = false;
                param.m_redirect_url = redirectUrl;
                browser.on("loadstart")
                    .subscribe((/**
                 * @param {?} e
                 * @return {?}
                 */
                function (e) {
                    if (e.url.startsWith(redirectUrl)) {
                        /** @type {?} */
                        var query = e.url.substring(redirectUrl.length + 1);
                        /** @type {?} */
                        var data = IamportService.parseQuery(query);
                        resolve(new IamportPayment(data));
                        browser.close();
                    }
                }));
                browser.on("loadstop")
                    .subscribe((/**
                 * @param {?} e
                 * @return {?}
                 */
                function (e) {
                    if (!paymentProgress && (e.url).indexOf(paymentUrl) > -1) {
                        paymentProgress = true;
                        /** @type {?} */
                        var inlineCallback = "(rsp) => {\n                                                        if( rsp.success ) {\n                                                            location.href = '" + redirectUrl + "?imp_success=true&imp_uid='+rsp.imp_uid+'&merchant_uid='+rsp.merchant_uid+'&vbank_num='+rsp.vbank_num+'&vbank_name='+rsp.vbank_name;\n                                                        } else {\n                                                            location.href = '" + redirectUrl + "?imp_success=false&imp_uid='+rsp.imp_uid+'&merchant_uid='+rsp.merchant_uid+'&error_msg='+rsp.error_msg;\n                                                        }\n                                                   }";
                        /** @type {?} */
                        var iamport_script = "IMP.request_pay(" + JSON.stringify(param) + ", " + inlineCallback + ")";
                        browser.executeScript({
                            code: iamport_script
                        });
                    }
                }), (/**
                 * @param {?} e
                 * @return {?}
                 */
                function (e) {
                }));
                browser.on("exit")
                    .subscribe((/**
                 * @param {?} e
                 * @return {?}
                 */
                function (e) {
                    reject("사용자가 결제를 취소하였습니다.");
                }));
                browser.show();
            }));
        }));
        return promise;
    };
    /**
     * @param {?} userCode
     * @param {?} param
     * @return {?}
     */
    IamportService.prototype.certification = /**
     * @param {?} userCode
     * @param {?} param
     * @return {?}
     */
    function (userCode, param) {
        var _this = this;
        /** @type {?} */
        var promise = new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        function (resolve, reject) {
            _this.platform.ready().then((/**
             * @return {?}
             */
            function () {
                /** @type {?} */
                var certificationUrl = '/_iamport_file_/www/iamport-checkout.html?user-code=' + userCode;
                if (_this.platform.is('ios')) {
                    certificationUrl = _this.file.applicationDirectory + 'www/iamport-checkout-ios.html?user-code=' + userCode;
                }
                /** @type {?} */
                var redirectUrl = "http://localhost/iamport-certification";
                /** @type {?} */
                var browser = _this.inAppBrowser.create(certificationUrl, '_blank', 'location=no');
                /** @type {?} */
                var certificationProgress = false;
                browser.on("loadstart")
                    .subscribe((/**
                 * @param {?} e
                 * @return {?}
                 */
                function (e) {
                    if (e.url.startsWith(redirectUrl)) {
                        /** @type {?} */
                        var query = e.url.substring(redirectUrl.length + 1);
                        /** @type {?} */
                        var data = IamportService.parseQuery(query);
                        resolve(new IamportCertification(data));
                        browser.close();
                    }
                }));
                browser.on("loadstop")
                    .subscribe((/**
                 * @param {?} e
                 * @return {?}
                 */
                function (e) {
                    if (!certificationProgress && (e.url).indexOf(certificationUrl) > -1) {
                        certificationProgress = true;
                        /** @type {?} */
                        var inlineCallback = "(rsp) => {\n                                                        if( rsp.success ) {\n                                                            location.href = '" + redirectUrl + "?imp_success=true&imp_uid='+rsp.imp_uid+'&merchant_uid='+rsp.merchant_uid;\n                                                        } else {\n                                                            location.href = '" + redirectUrl + "?imp_success=false&imp_uid='+rsp.imp_uid+'&merchant_uid='+rsp.merchant_uid;\n                                                        }\n                                                   }";
                        /** @type {?} */
                        var iamport_script = "IMP.certification(" + JSON.stringify(param) + ", " + inlineCallback + ")";
                        browser.executeScript({
                            code: iamport_script
                        });
                    }
                }), (/**
                 * @param {?} e
                 * @return {?}
                 */
                function (e) {
                }));
                browser.on("exit")
                    .subscribe((/**
                 * @param {?} e
                 * @return {?}
                 */
                function (e) {
                    reject("사용자가 본인인증을 취소하였습니다.");
                }));
                browser.show();
            }));
        }));
        return promise;
    };
    IamportService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    IamportService.ctorParameters = function () { return [
        { type: Platform },
        { type: InAppBrowser },
        { type: File }
    ]; };
    /** @nocollapse */ IamportService.ngInjectableDef = i0.defineInjectable({ factory: function IamportService_Factory() { return new IamportService(i0.inject(i1.Platform), i0.inject(i2.InAppBrowser), i0.inject(i3.File)); }, token: IamportService, providedIn: "root" });
    return IamportService;
}());
export { IamportService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    IamportService.prototype.platform;
    /**
     * @type {?}
     * @private
     */
    IamportService.prototype.inAppBrowser;
    /**
     * @type {?}
     * @private
     */
    IamportService.prototype.file;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWFtcG9ydC1pb25pYzQta2NwLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9pYW1wb3J0LWlvbmljNC1rY3AvIiwic291cmNlcyI6WyJsaWIvaWFtcG9ydC1pb25pYzQta2NwLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUN6QyxPQUFPLEVBQUMsY0FBYyxFQUFDLE1BQU0sbUJBQW1CLENBQUM7QUFDakQsT0FBTyxFQUFDLG9CQUFvQixFQUFDLE1BQU0seUJBQXlCLENBQUM7QUFDN0QsT0FBTyxFQUFDLFFBQVEsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ3hDLE9BQU8sRUFBQyxJQUFJLEVBQUMsTUFBTSx3QkFBd0IsQ0FBQztBQUM1QyxPQUFPLEVBQUMsWUFBWSxFQUFDLE1BQU0sa0NBQWtDLENBQUM7Ozs7O0FBRTlEO0lBS0Usd0JBQW9CLFFBQWtCLEVBQVUsWUFBMEIsRUFBVSxJQUFVO1FBQTFFLGFBQVEsR0FBUixRQUFRLENBQVU7UUFBVSxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUFVLFNBQUksR0FBSixJQUFJLENBQU07SUFFOUYsQ0FBQzs7Ozs7O0lBRWMseUJBQVU7Ozs7O0lBQXpCLFVBQTBCLEtBQWE7OztZQUNqQyxHQUFHLEdBQUcsRUFBRTs7WUFDUixHQUFHLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUM7O1lBRTFCLEtBQW9CLElBQUEsUUFBQSxpQkFBQSxHQUFHLENBQUEsd0JBQUEseUNBQUU7Z0JBQXBCLElBQUksT0FBTyxnQkFBQTs7b0JBQ1IsSUFBSSxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDOztvQkFDekIsR0FBRyxHQUFHLGtCQUFrQixDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQzs7b0JBQ2pDLEdBQUcsR0FBRyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7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Z0IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFO3dCQUNwRSxxQkFBcUIsR0FBRyxJQUFJLENBQUM7OzRCQUV2QixjQUFjLEdBQUcsMktBRW9DLFdBQVcsbU9BRVgsV0FBVyxpTUFFckM7OzRCQUMzQixjQUFjLEdBQUcsdUJBQXFCLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLFVBQUssY0FBYyxNQUFHO3dCQUV2RixPQUFPLENBQUMsYUFBYSxDQUFDOzRCQUNwQixJQUFJLEVBQUUsY0FBYzt5QkFDckIsQ0FBQyxDQUFDO3FCQUNKO2dCQUNILENBQUM7Ozs7Z0JBQUUsVUFBQyxDQUFDO2dCQUVMLENBQUMsRUFDSixDQUFDO2dCQUVOLE9BQU8sQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDO3FCQUNiLFNBQVM7Ozs7Z0JBQ04sVUFBQyxDQUFDO29CQUNBLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO2dCQUNoQyxDQUFDLEVBQ0osQ0FBQztnQkFFTixPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDakIsQ0FBQyxFQUFDLENBQUM7UUFDTCxDQUFDLEVBQUM7UUFFRixPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDOztnQkEzSkYsVUFBVSxTQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQjs7OztnQkFOTyxRQUFRO2dCQUVSLFlBQVk7Z0JBRFosSUFBSTs7O3lCQUpaO0NBbUtDLEFBNUpELElBNEpDO1NBekpZLGNBQWM7Ozs7OztJQUViLGtDQUEwQjs7Ozs7SUFBRSxzQ0FBa0M7Ozs7O0lBQUUsOEJBQWtCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJbmplY3RhYmxlfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7SWFtcG9ydFBheW1lbnR9IGZyb20gXCIuL2lhbXBvcnQucGF5bWVudFwiO1xuaW1wb3J0IHtJYW1wb3J0Q2VydGlmaWNhdGlvbn0gZnJvbSBcIi4vaWFtcG9ydC5jZXJ0aWZpY2F0aW9uXCI7XG5pbXBvcnQge1BsYXRmb3JtfSBmcm9tIFwiQGlvbmljL2FuZ3VsYXJcIjtcbmltcG9ydCB7RmlsZX0gZnJvbSBcIkBpb25pYy1uYXRpdmUvZmlsZS9uZ3hcIjtcbmltcG9ydCB7SW5BcHBCcm93c2VyfSBmcm9tIFwiQGlvbmljLW5hdGl2ZS9pbi1hcHAtYnJvd3Nlci9uZ3hcIjtcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgSWFtcG9ydFNlcnZpY2Uge1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcGxhdGZvcm06IFBsYXRmb3JtLCBwcml2YXRlIGluQXBwQnJvd3NlcjogSW5BcHBCcm93c2VyLCBwcml2YXRlIGZpbGU6IEZpbGUpIHtcblxuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgcGFyc2VRdWVyeShxdWVyeTogc3RyaW5nKSB7XG4gICAgbGV0IG9iaiA9IHt9LFxuICAgICAgICBhcnIgPSBxdWVyeS5zcGxpdCgnJicpO1xuXG4gICAgZm9yIChsZXQgZWxlbWVudCBvZiBhcnIpIHtcbiAgICAgIGNvbnN0IHBhaXIgPSBlbGVtZW50LnNwbGl0KFwiPVwiKTtcbiAgICAgIGNvbnN0IGtleSA9IGRlY29kZVVSSUNvbXBvbmVudChwYWlyWzBdKTtcbiAgICAgIGNvbnN0IHZhbCA9IGRlY29kZVVSSUNvbXBvbmVudChwYWlyWzFdKTtcblxuICAgICAgaWYgKGtleSA9PT0gXCJpbXBfc3VjY2Vzc1wiKSB7XG4gICAgICAgIG9ialtcInN1Y2Nlc3NcIl0gPSAoXCJ0cnVlXCIgPT09IHZhbCk7IC8vc3RyaW5nIOydhCBib29sZWFuIOycvOuhnFxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb2JqW2tleV0gPSB2YWw7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG9iajtcbiAgfVxuXG4gIHB1YmxpYyBwYXltZW50KHVzZXJDb2RlOiBzdHJpbmcsIHBhcmFtKTogUHJvbWlzZTxJYW1wb3J0UGF5bWVudD4ge1xuICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZTxJYW1wb3J0UGF5bWVudD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5wbGF0Zm9ybS5yZWFkeSgpLnRoZW4oKCkgPT4ge1xuICAgICAgICBsZXQgcGF5bWVudFVybCA9ICcvX2lhbXBvcnRfZmlsZV8vd3d3L2lhbXBvcnQtY2hlY2tvdXQuaHRtbD91c2VyLWNvZGU9JyArIHVzZXJDb2RlO1xuICAgICAgICBpZiAodGhpcy5wbGF0Zm9ybS5pcygnaW9zJykpIHtcbiAgICAgICAgICBwYXltZW50VXJsID0gdGhpcy5maWxlLmFwcGxpY2F0aW9uRGlyZWN0b3J5ICsgJ3d3dy9pYW1wb3J0LWNoZWNrb3V0LWlvcy5odG1sP3VzZXItY29kZT0nICsgdXNlckNvZGU7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZWRpcmVjdFVybCA9IFwiaHR0cDovL2xvY2FsaG9zdC9pYW1wb3J0XCI7XG4gICAgICAgIGNvbnN0IGJyb3dzZXIgPSB0aGlzLmluQXBwQnJvd3Nlci5jcmVhdGUocGF5bWVudFVybCwgJ19ibGFuaycsICdsb2NhdGlvbj1ubycpO1xuICAgICAgICBsZXQgcGF5bWVudFByb2dyZXNzID0gZmFsc2U7XG5cbiAgICAgICAgcGFyYW0ubV9yZWRpcmVjdF91cmwgPSByZWRpcmVjdFVybDtcblxuICAgICAgICBicm93c2VyLm9uKFwibG9hZHN0YXJ0XCIpXG4gICAgICAgICAgICAuc3Vic2NyaWJlKFxuICAgICAgICAgICAgICAgIChlKSA9PiB7XG4gICAgICAgICAgICAgICAgICBpZiAoZS51cmwuc3RhcnRzV2l0aChyZWRpcmVjdFVybCkpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcXVlcnkgPSBlLnVybC5zdWJzdHJpbmcocmVkaXJlY3RVcmwubGVuZ3RoICsgMSk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBJYW1wb3J0U2VydmljZS5wYXJzZVF1ZXJ5KHF1ZXJ5KTtcblxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKG5ldyBJYW1wb3J0UGF5bWVudChkYXRhKSk7XG4gICAgICAgICAgICAgICAgICAgIGJyb3dzZXIuY2xvc2UoKTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuXG4gICAgICAgIGJyb3dzZXIub24oXCJsb2Fkc3RvcFwiKVxuICAgICAgICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAoZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgaWYgKCFwYXltZW50UHJvZ3Jlc3MgJiYgKGUudXJsKS5pbmRleE9mKHBheW1lbnRVcmwpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgcGF5bWVudFByb2dyZXNzID0gdHJ1ZTtcblxuICAgICAgICAgICAgICAgICAgICBjb25zdCBpbmxpbmVDYWxsYmFjayA9IGAocnNwKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCByc3Auc3VjY2VzcyApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uLmhyZWYgPSAnJHtyZWRpcmVjdFVybH0/aW1wX3N1Y2Nlc3M9dHJ1ZSZpbXBfdWlkPScrcnNwLmltcF91aWQrJyZtZXJjaGFudF91aWQ9Jytyc3AubWVyY2hhbnRfdWlkKycmdmJhbmtfbnVtPScrcnNwLnZiYW5rX251bSsnJnZiYW5rX25hbWU9Jytyc3AudmJhbmtfbmFtZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uLmhyZWYgPSAnJHtyZWRpcmVjdFVybH0/aW1wX3N1Y2Nlc3M9ZmFsc2UmaW1wX3VpZD0nK3JzcC5pbXBfdWlkKycmbWVyY2hhbnRfdWlkPScrcnNwLm1lcmNoYW50X3VpZCsnJmVycm9yX21zZz0nK3JzcC5lcnJvcl9tc2c7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1gO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBpYW1wb3J0X3NjcmlwdCA9IGBJTVAucmVxdWVzdF9wYXkoJHtKU09OLnN0cmluZ2lmeShwYXJhbSl9LCAke2lubGluZUNhbGxiYWNrfSlgO1xuXG4gICAgICAgICAgICAgICAgICAgIGJyb3dzZXIuZXhlY3V0ZVNjcmlwdCh7XG4gICAgICAgICAgICAgICAgICAgICAgY29kZTogaWFtcG9ydF9zY3JpcHRcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSwgKGUpID0+IHtcblxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgYnJvd3Nlci5vbihcImV4aXRcIilcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgKGUpID0+IHtcbiAgICAgICAgICAgICAgICAgIHJlamVjdChcIuyCrOyaqeyekOqwgCDqsrDsoJzrpbwg7Leo7IaM7ZWY7JiA7Iq164uI64ukLlwiKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuXG4gICAgICAgIGJyb3dzZXIuc2hvdygpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gcHJvbWlzZTtcbiAgfVxuXG4gIHB1YmxpYyBjZXJ0aWZpY2F0aW9uKHVzZXJDb2RlOiBzdHJpbmcsIHBhcmFtKTogUHJvbWlzZTxJYW1wb3J0Q2VydGlmaWNhdGlvbj4ge1xuICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZTxJYW1wb3J0Q2VydGlmaWNhdGlvbj4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5wbGF0Zm9ybS5yZWFkeSgpLnRoZW4oKCkgPT4ge1xuICAgICAgICBsZXQgY2VydGlmaWNhdGlvblVybCA9ICcvX2lhbXBvcnRfZmlsZV8vd3d3L2lhbXBvcnQtY2hlY2tvdXQuaHRtbD91c2VyLWNvZGU9JyArIHVzZXJDb2RlO1xuICAgICAgICBpZiAodGhpcy5wbGF0Zm9ybS5pcygnaW9zJykpIHtcbiAgICAgICAgICBjZXJ0aWZpY2F0aW9uVXJsID0gdGhpcy5maWxlLmFwcGxpY2F0aW9uRGlyZWN0b3J5ICsgJ3d3dy9pYW1wb3J0LWNoZWNrb3V0LWlvcy5odG1sP3VzZXItY29kZT0nICsgdXNlckNvZGU7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZWRpcmVjdFVybCA9IFwiaHR0cDovL2xvY2FsaG9zdC9pYW1wb3J0LWNlcnRpZmljYXRpb25cIjtcbiAgICAgICAgY29uc3QgYnJvd3NlciA9IHRoaXMuaW5BcHBCcm93c2VyLmNyZWF0ZShjZXJ0aWZpY2F0aW9uVXJsLCAnX2JsYW5rJywgJ2xvY2F0aW9uPW5vJyk7XG5cbiAgICAgICAgbGV0IGNlcnRpZmljYXRpb25Qcm9ncmVzcyA9IGZhbHNlO1xuXG4gICAgICAgIGJyb3dzZXIub24oXCJsb2Fkc3RhcnRcIilcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgKGUpID0+IHtcbiAgICAgICAgICAgICAgICAgIGlmIChlLnVybC5zdGFydHNXaXRoKHJlZGlyZWN0VXJsKSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBxdWVyeSA9IGUudXJsLnN1YnN0cmluZyhyZWRpcmVjdFVybC5sZW5ndGggKyAxKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IElhbXBvcnRTZXJ2aWNlLnBhcnNlUXVlcnkocXVlcnkpO1xuXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUobmV3IElhbXBvcnRDZXJ0aWZpY2F0aW9uKGRhdGEpKTtcbiAgICAgICAgICAgICAgICAgICAgYnJvd3Nlci5jbG9zZSgpO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgYnJvd3Nlci5vbihcImxvYWRzdG9wXCIpXG4gICAgICAgICAgICAuc3Vic2NyaWJlKFxuICAgICAgICAgICAgICAgIChlKSA9PiB7XG4gICAgICAgICAgICAgICAgICBpZiAoIWNlcnRpZmljYXRpb25Qcm9ncmVzcyAmJiAoZS51cmwpLmluZGV4T2YoY2VydGlmaWNhdGlvblVybCkgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICBjZXJ0aWZpY2F0aW9uUHJvZ3Jlc3MgPSB0cnVlO1xuXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGlubGluZUNhbGxiYWNrID0gYChyc3ApID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIHJzcC5zdWNjZXNzICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYXRpb24uaHJlZiA9ICcke3JlZGlyZWN0VXJsfT9pbXBfc3VjY2Vzcz10cnVlJmltcF91aWQ9Jytyc3AuaW1wX3VpZCsnJm1lcmNoYW50X3VpZD0nK3JzcC5tZXJjaGFudF91aWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhdGlvbi5ocmVmID0gJyR7cmVkaXJlY3RVcmx9P2ltcF9zdWNjZXNzPWZhbHNlJmltcF91aWQ9Jytyc3AuaW1wX3VpZCsnJm1lcmNoYW50X3VpZD0nK3JzcC5tZXJjaGFudF91aWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1gO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBpYW1wb3J0X3NjcmlwdCA9IGBJTVAuY2VydGlmaWNhdGlvbigke0pTT04uc3RyaW5naWZ5KHBhcmFtKX0sICR7aW5saW5lQ2FsbGJhY2t9KWA7XG5cbiAgICAgICAgICAgICAgICAgICAgYnJvd3Nlci5leGVjdXRlU2NyaXB0KHtcbiAgICAgICAgICAgICAgICAgICAgICBjb2RlOiBpYW1wb3J0X3NjcmlwdFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LCAoZSkgPT4ge1xuXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcblxuICAgICAgICBicm93c2VyLm9uKFwiZXhpdFwiKVxuICAgICAgICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAoZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgcmVqZWN0KFwi7IKs7Jqp7J6Q6rCAIOuzuOyduOyduOymneydhCDst6jshoztlZjsmIDsirXri4jri6QuXCIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgYnJvd3Nlci5zaG93KCk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIHJldHVybiBwcm9taXNlO1xuICB9XG59XG4iXX0=